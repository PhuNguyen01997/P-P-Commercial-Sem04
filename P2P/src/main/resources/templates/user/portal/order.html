<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/portal-layout}">
<head>
    <meta charset="UTF-8">
    <title>ShoPP</title>
</head>
<body>
<div layout:fragment="content" class="main-inner order">
    <input type="hidden" th:value="${shop.id}" name="shopId">

    <ul class="order-header">
        <li class="order-header--item jsStatus active" data-status-id="0">
            <p>Tất cả</p>
        </li>
        <li class="order-header--item jsStatus" data-status-id="1">
            <p>Chờ xác nhận</p>
        </li>
        <li class="order-header--item jsStatus" data-status-id="2">
            <p>Chờ lấy hàng</p>
        </li>
        <li class="order-header--item jsStatus" data-status-id="3">
            <p>Đang giao</p>
        </li>
        <li class="order-header--item jsStatus" data-status-id="4">
            <p>Đã giao</p>
        </li>
        <!--        <li class="order-header&#45;&#45;item">-->
        <!--            <p>Đơn hủy</p>-->
        <!--        </li>-->
        <!--        <li class="order-header&#45;&#45;item">-->
        <!--            <p>Trả hàng/Hoàn tiền</p>-->
        <!--        </li>-->
        <li class="order-header--bar"></li>
    </ul>
    <div class="order-block order-block__date">
        <label for="date" class="txt">Ngày đặt hàng</label>
        <input id="date" type="text" name="date" class="jsDateRangePicker ipt">
    </div>
    <div class="order-block order-block__name">
        <div class="select">
            <select name="type" id="" class="jsFilterBy">
                <option value="1" selected>Mã đơn hàng</option>
                <option value="2">Tên người mua</option>
                <option value="3">Sản phẩm</option>
            </select>
        </div>
        <input class="ipt jsName" type="text">
        <button class="btn submit btn__primary jsSubmit">Tìm kiếm</button>
        <button class="btn clear btn__white jsClear">Đặt lại</button>
    </div>
    <p class="order-block order-block__count"><span class="jsCount">0</span> <span>Đơn Hàng</span></p>
    <div class="order-block order-block__table">
        <div class="table-header">
            <div class="table-col table-col__name">
                <p>Sản phẩm</p>
            </div>
            <div class="table-col table-col__price">
                <p>Tổng đơn hàng</p>
            </div>
            <div class="table-col table-col__date">
                <p>Thời gian tạo</p>
            </div>
            <div class="table-col table-col__status">
                <p>Thạng thái</p>
            </div>
            <div class="table-col table-col__action">
                <p>Thao tác</p>
            </div>
        </div>
        <ul class="table-body jsContainer"></ul>
    </div>
</div>

<script layout:fragment="script">
    $(function () {
        function setActive(ele) {
            const width = $(ele).outerWidth();
            const position = $(ele).position();

            $('.order-header--bar').css({
                width,
                transform: `translateX(${position.left}px)`
            });
        }

        function setFilter() {
            const date = $('input[name="date"]').val().match(/.+(?=\s\-\s)|(?<=\s\-\s).+/gm);
            filter = {
                statusId: $('.jsStatus.active')[0].dataset.statusId,
                filterBy: $('.jsFilterBy').val(),
                name: $('.jsName').val(),
                minDate: date[0],
                maxDate: date[1],
            }
        }

        function renderOrder() {
            setFilter();
            setGlobalLoading(true);
            const shopId = $('input[name="shopId"]').val();
            $.ajax({
                url: `${window.location.protocol}//${window.location.host}/api/shop/${shopId}/order`,
                cache: false,
                type: 'POST',
                contentType: "application/json",
                data: JSON.stringify(filter),
                success: function (orders) {
                    $('.jsCount').text(orders.length)

                    let htmlText = "";
                    orders.forEach((order) => {
                        const createdDate = new Date(Date.parse(order.createdAt));

                        htmlText += `<li class="table-body--row">` +
                            `<div class="table-body--row-header">` +
                            `<p class="avatar circle"><img src="/img/common/img_default_user.png" alt=""></p>` +
                            `<p class="name">${order.user.username}</p>` +
                            `<p class="order-info">ID đơn hàng: <span>${order.id}</span></p>` +
                            `</div>` +
                            `<ul class="table-body--row-list">`;
                        order.orderDetails.forEach(ode => {
                            htmlText += `<li class="table-body--row-item">` +
                                `<div class="table-col table-col__name">` +
                                `<img src="/img/products/product_01.jpg" alt="">` +
                                `<div class="info"><p class="txt">${ode.product.name}</p><p class="number">x${ode.quantity}</p></div>` +
                                `</div>` +
                                `<div class="table-col table-col__price"><p>${ode.lastPrice} vnđ</p></div>` +
                                `<div class="table-col table-col__date">` +
                                `<p>${getStringDateFormat(createdDate)}</p>` +
                                `<p>${getStringTimeFormat(createdDate)}</p>` +
                                `</div>` +
                                `<div class="table-col table-col__status">${order.currentStatus.name}</div>` +
                                `<div class="table-col table-col__action">` +
                                `<a href="javascript: void(0);">[Next update status order]</a>` +
                                `</div>` +
                                `</li>`;
                        })
                        htmlText += `</ul>` + `</li>`;
                    })
                    $('.jsContainer').html(htmlText);

                    setGlobalLoading(false);
                },
                error: function (xhr, error, response) {
                    console.log({xhr, error, response});
                    setGlobalLoading(false);
                },
            });
        }

        let filter = {};

        setActive($('.jsStatus')[0]);
        renderOrder();

        $('.jsStatus').on('click', function () {
            $('.jsStatus').removeClass('active');
            $(this).addClass('active');
            setActive(this);
        })

        $('.jsSubmit').on('click', function () {
            renderOrder();
        })
    });
</script>
</body>
</html>